# RetailAI Copilot - 平台架构设计

**版本**: 1.0  
**创建日期**: 2026-02-25  
**状态**: draft

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层                                    │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│   │  门店执行端  │  │  总部决策端  │  │  配置中心   │            │
│   │  (小程序)   │  │   (Web)     │  │   (Web)     │            │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
└──────────┼────────────────┼────────────────┼───────────────────┘
           │                │                │
┌──────────▼────────────────▼────────────────▼───────────────────┐
│                        API Gateway                              │
│              (认证、限流、路由、日志)                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      应用服务层                                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ 租户服务 │ │ 补货服务 │ │ 用户服务 │ │ 商品服务 │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ 搭配服务 │ │ 预测服务 │ │ 通知服务 │ │ 日志服务 │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      AI 引擎层                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 销量预测模型 │ │ 推荐引擎     │ │ NLP 引擎     │            │
│  │ (时间序列)   │ │ (协同过滤)   │ │ (RAG)        │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│  ┌──────────────┐ ┌──────────────┐                              │
│  │ 图像识别     │ │ RLHF 优化    │                              │
│  │ (多模态)     │ │ (反馈学习)   │                              │
│  └──────────────┘ └──────────────┘                              │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      数据层                                      │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ PostgreSQL   │ │ Redis        │ │ MongoDB      │            │
│  │ (业务数据)   │ │ (缓存/会话)  │ │ (日志/行为)  │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│  ┌──────────────┐ ┌──────────────┐                              │
│  │ 对象存储     │ │ 向量数据库   │                              │
│  │ (图片/文件)  │ │ (知识库)     │                              │
│  └──────────────┘ └──────────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 技术选型

### 前端技术栈

| 端 | 技术 | 说明 |
|----|------|------|
| 门店执行端 | 微信小程序 + Taro | 跨端支持，可编译为 H5/APP |
| 总部决策端 | React + Ant Design Pro | 企业级后台 |
| 配置中心 | React + Ant Design Pro | 企业级后台 |

### 后端技术栈

| 层次 | 技术 | 说明 |
|------|------|------|
| API Gateway | Kong / APISIX | 开源网关，支持插件 |
| 应用服务 | Node.js (NestJS) + Python (FastAPI) | 业务逻辑 + AI 服务 |
| 数据库 | PostgreSQL 15 | 主数据库，支持行级安全 |
| 缓存 | Redis 7 | 会话、热点数据 |
| 消息队列 | RabbitMQ / Kafka | 异步任务、事件驱动 |

### AI 技术栈

| 能力 | 技术方案 | 说明 |
|------|---------|------|
| 销量预测 | Prophet + LSTM | 时间序列预测 |
| 推荐引擎 | LightFM + 规则引擎 | 混合推荐 |
| NLP/RAG | Qwen + LangChain | 知识库问答 |
| 图像识别 | ResNet + CLIP | 商品识别、搭配 |
| RLHF | 自定义反馈收集 | 人工反馈优化 |

### 基础设施

| 组件 | 技术 | 说明 |
|------|------|------|
| 容器化 | Docker + K8s | 容器编排 |
| CI/CD | GitHub Actions / GitLab CI | 自动化部署 |
| 监控 | Prometheus + Grafana | 性能监控 |
| 日志 | ELK Stack | 日志收集分析 |
| 云服务 | 阿里云 / 腾讯云 | 国内部署 |

---

## 多租户架构

### 数据隔离策略

采用 **Schema 隔离** 模式：

```
PostgreSQL
├── schema: tenant_001
│   ├── users
│   ├── stores
│   ├── orders
│   └── ...
├── schema: tenant_002
│   ├── users
│   ├── stores
│   ├── orders
│   └── ...
└── schema: platform
    ├── tenants
    ├── global_config
    └── ...
```

**优点**:
- 数据隔离清晰，安全性高
- 备份恢复可按租户进行
- 扩展性好，支持租户独立迁移

**实现**:
- 应用层通过租户 ID 动态切换 Schema
- PostgreSQL Row Level Security 作为第二道防线

---

## 核心领域划分

```
┌─────────────────────────────────────────────────────────┐
│                    平台域 (Platform)                     │
│  租户管理 | 账号管理 | 权限管理 | 组织架构 | 门店管理    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    业务域 (Business)                     │
│  补货域 | 商品域 | 用户域 | 订单域 | 库存域              │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    AI 域 (AI Engine)                     │
│  预测域 | 推荐域 | NLP 域 | 视觉域 | 优化域               │
└─────────────────────────────────────────────────────────┘
```

---

## 关键架构决策（ADR）

### ADR-001: 多租户数据隔离策略

**决策**: 采用 PostgreSQL Schema 隔离

**理由**:
- 安全性要求高，租户数据必须物理隔离
- 相比独立数据库，成本更低
- 相比共享 Schema，隔离性更好

**影响**:
- 数据库连接池需要支持动态 Schema 切换
- 跨租户数据分析需要特殊处理

### ADR-002: 前后端分离架构

**决策**: 前端 SPA + 后端 RESTful API

**理由**:
- 前端可独立部署和迭代
- 支持多端（小程序、Web、APP）
- 后端可专注于业务逻辑

**影响**:
- 需要处理 CORS、认证 Token
- SEO 需要考虑（总部端不重要）

### ADR-003: AI 服务独立部署

**决策**: AI 引擎独立为服务层，通过 gRPC 通信

**理由**:
- AI 服务资源需求高（GPU）
- 可独立扩展和升级
- 业务服务与 AI 解耦

**影响**:
- 需要处理服务间通信延迟
- 需要设计降级策略（AI 不可用时）

---

## 安全设计

### 认证与授权

```
用户登录 → JWT Token → API Gateway 验证 → 服务层权限检查
```

- **JWT Token**: 包含用户 ID、租户 ID、角色信息
- **Token 有效期**: 2 小时，支持刷新
- **权限检查**: 基于 RBAC，服务层二次验证

### 数据安全

- **传输加密**: HTTPS/TLS 1.3
- **存储加密**: 敏感字段 AES-256 加密
- **密码存储**: bcrypt + salt
- **数据备份**: 每日全量 + 实时增量

### 审计与合规

- **操作日志**: 所有写操作记录日志
- **数据访问**: 敏感数据访问记录
- **合规要求**: 满足网络安全法、个人信息保护法

---

## 性能设计

### 缓存策略

```
L1: 客户端缓存 (LocalStorage) - 静态资源
L2: CDN 缓存 - 图片、文件
L3: Redis 缓存 - 热点数据、会话
L4: 数据库查询缓存 - 复杂查询结果
```

### 数据库优化

- **索引设计**: 高频查询字段建立索引
- **读写分离**: 主库写，从库读
- **分库分表**: 单表超过 1000 万行考虑分表
- **慢查询监控**: 超过 1 秒的查询告警

### 异步处理

- **消息队列**: 通知、报表、数据同步
- **定时任务**: 预测模型更新、数据清理
- **批量处理**: 大批量数据导入导出

---

## 部署架构

```
┌─────────────────────────────────────────────────────────┐
│                      负载均衡 (SLB)                      │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
┌───────▼───────┐ ┌──▼────────┐ ┌─▼─────────────┐
│  API Gateway  │ │ API Gateway│ │ API Gateway   │
│   (K8s Pod)   │ │  (K8s Pod) │ │  (K8s Pod)    │
└───────┬───────┘ └───┬────────┘ └─┬─────────────┘
        │            │             │
        └────────────┼─────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
┌───────▼───────┐ ┌──▼────────┐ ┌─▼─────────────┐
│  应用服务     │ │ 应用服务   │ │ AI 服务        │
│  (K8s Pod)    │ │ (K8s Pod) │ │ (GPU Node)    │
└───────────────┘ └───────────┘ └───────────────┘
```

---

## 监控与告警

### 监控指标

| 类别 | 指标 | 阈值 |
|------|------|------|
| 应用 | API 响应时间 (P95) | < 500ms |
| 应用 | 错误率 | < 1% |
| 应用 | QPS | 根据容量 |
| 数据库 | 连接数 | < 80% |
| 数据库 | 慢查询数 | < 10/分钟 |
| 缓存 | 命中率 | > 90% |
| AI | 预测延迟 | < 5 秒 |
| AI | 模型准确率 | > 80% |

### 告警渠道

- **P0 紧急**: 电话 + 短信 + 企业微信
- **P1 重要**: 短信 + 企业微信
- **P2 一般**: 企业微信

---

*文档状态：待 Human 确认*
